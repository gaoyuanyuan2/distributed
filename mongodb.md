# MongoDB

# 什么是MongoDB (内存、AP:最终一致性、C++）

## MongoDB是一个开源文档数据库，提供高性能，高可用性和自动扩展。

## 文件数据库

MongoDB中的记录是一个文档，它是由字段和值对组成的数据结构。MongoDB文档类似于JSON对象。字段的值可以包括其他文档，数组和文档数组。

## MongoDB文档。

使用文档的好处是：

文档（即对象）对应于许多编程语言中的本机数据类型。

嵌入式文档和数组减少了对昂贵连接的需求。

动态模式支持流畅的多态性。

## 主要特点

* 高性能

MongoDB提供高性能数据持久性。特别是，

对嵌入式数据模型的支持减少了数据库系统的I / O活动。

索引支持更快的查询，并且可以包含来自嵌入式文档和数组的键。

丰富的查询语言

MongoDB支持丰富的查询语言以支持读写操作（CRUD）以及：

* 数据聚合

文本搜索和地理空间查询。

* 高可用性

MongoDB的复制工具称为副本集，它提供：

自动故障转移和数据冗余。

副本集是一组保持相同的数据集，从而提供冗余和提高数据可用性的MongoDB服务器。

* 水平可伸缩性

MongoDB提供水平可伸缩性作为其核心 功能的一部分：分片在一组计算机集群分布数据。

* MongoDB支持多个存储引擎

1.  没有表结构的概念,每条记录可以有完全不同的结构

2.  业务开发方便快捷

3.  完全的索引支持

4.  方便的冗余与扩展

1) 复制集保证数据安全

2) 分片扩展数据规模

5.  最像关系性数据库（事务、表关联、表结构）的非关系性数据库（无事务、无关联、key-value）

![](/img/63.png) 
![写](/img/60.png) 

仲裁节点不存数据，监测副本集心跳。仲裁节点意义不大。一般不用此模式。

config相当于索引

仲裁节点不存数据，监测副本集心跳。

分片 存储在各个节点 分发 归纳。

![读](/img/61.png) 


去热点：数据存储要均衡。分块：类似redis hash槽

## MongoDB的数据结构与关系型数据库数据结构对比

|关系型数据库术语/概念|MongoDB术语/概念|  解释/说明|
|:------------:|:--:|:--:|
|Database|  Database | 数据库|
|Table | Collection  |数据库表/集合|
|  row| Document | 数据记录行/文档|
|Column | Field  |数据列/数据字段|
|Index  |Index  |素引|
|Table joins| |表关联/MongoDB不支持|
|Primary Key|Object ID  |主键MongoDB自动将，_id设置为主键|

|类型 | 典型代表|  特点|
|:--:|:--:|:--:|
|列存储| Hbase | 顾名思义，是按照列存储数据的。最大的特点是方便存储结构化和半结构化的数据，方便做数据压缩，对针对某一列或者某几列的查询有非常大的IO优势|
|文档存诸 |MongoDB | 文档存储一般用类似json的格式存储，存储的内容是文档型的。这样也就有机会对某些字段建立素引，实现关系数据库的某些功能。|
|Key-value存储| Redis |可以通过key快速查询到其value.一般来说，存储不管value的格式，照单全收。(Redis.包含了其他功能)|

## MongoDB的应用场景和不适用场景

###  1、适用场景

1.  根据MongoDB官网的说明，MongoDB 的适用场景如下:

1)网站实时数据:MongoDB非常适合实时的插入，更新与查询，并具备网站实时数据存储所需的复制及高度伸缩性。

2)数据缓存:由于性能很高，MongoDB 也适合作为信息基础设施的缓存层。在系统重启之后，由MongoDB搭建的持久化缓存层可以避免下层的数据源过载。

3)大尺寸、低价值数据存储:使用传统的关系型数据库存储一些数据时可能会比较昂贵，在此之前，很多时候程序员往往会选择传统的文件进行存储。

eg：网盘数据分片存储，索引放在内存

4)高伸缩性场景:MongoDB非常适合由数十或数百台服务器组成的数据库。MongoDB的路线图中已经包含对MapReduce引擎的内置支持。

5)对象或JSON数据存储:MongoDB的BSON数据格式非常适合文档化格式的存储及查询。

2、不适用场景

了解了MongoDB适用场景之后，还需要了解哪些场景下不适合使用MongoDB,具体如下:

1)高度事务性系统例如银行或会计系统。传统的关系型数据库目前还是更适用于需要大量原子性复杂事务的应用程序。

2)传统的商业智能应用:针对特定问题的BI数据库会对产生高度优化的查询方式。对于此类应用，数据仓库可能是更合适的选择。

3)需要复杂SQL查询的问题。

相信通过上面的说明，你已经大致了解了MongoDB 的使用规则，需要说明一点的是，MongoDB不仅仅是数据库,更多的使用是将
MongoDB作为一个数据库中间件在实际应用中合理划分使用细节，这一点对于MongoDB应用来讲至关重要!

## MongoDB高可用方案

RouteServer (路由服务器)

ConfigServer (配置服务器)

ReplicaSet (副本集)

Shard (切片)

Chunk (分块)


M-S-S，M-S-A 仲裁节点

## mongos

生产配置

在生产群集中，确保数据冗余并确保系统具有高可用性。对于生产分片集群部署，请考虑以下事项：

将Config Server部署为3成员副本集

将每个Shard部署为3个成员副本集

部署一个或多个mongos路由器


在两个数据中心分发中，

如果其中一个数据中心发生故障，则数据仍然可用于读取，这与单个数据中心分发不同。

如果具有少数成员的数据中心发生故障，则副本集仍可以提供写操作以及读操作。

但是，如果具有大多数成员的数据中心发生故障，则副本集将变为只读。

如果可能，请至少在三个数据中心分发成员。对于配置服务器副本集（CSRS），最佳做法是分配三个（或更多，具体取决于成员数量）中心。
如果第三个数据中心的成本过高，一种分配的可能性是将数据承载成员均匀地分布在两个数据中心并存储其余成员（数据承载成员或仲裁者以确保成员数量奇数）


分片需要至少两个分片来分配分片数据。

mongos分配数量

部署多个mongos路由器支持高可用性和可扩展性。常见的模式是mongos在每个应用程序服务器上放置一个 。mongos在每个应用服务器上部署一个 路由器可以减少应用程序和路由器之间的网络延迟。
或者，您可以将mongos路由器放在专用主机上。大型部署受益于此方法，因为它将客户端应用程序服务器的数量与mongos实例数量分离 。这样可以更好地控制mongod实例所服务的连接数。

mongos在自己的主机上安装实例允许这些实例使用更大量的内存。内存不会与mongod实例共享。可以使用主分片来托管mongos路由器，但要注意内存争用可能会成为大型部署的问题。

mongos您可以在部署中使用的路由器数量没有限制。但是，由于mongos路由器经常与配置服务器通信，因此在增加路由器数量时会密切监视配置服务器性能。如果您发现性能下降，那么限制mongos部署中的路由器数量可能会有所帮助 。

配置服务器  存储分片集群的元数据。元数据反映了分片集群中所有数据和组件的状态和组织。元数据包括每个分片上的块列表以及定义块的范围。


该mongos实例缓存这些数据，并用它来路由读写操作，以正确的碎片。mongos 当群集有元数据更改时更新缓存，例如Chunk Splits或添加分片。Shards还从配置服务器读取块元数据。


配置服务器还存储身份验证配置信息，例如基于角色的访问控制或群集的内部身份验证设置。

MongoDB还使用配置服务器来管理分布式锁。

每个分片群集必须具有自己的配置服务器。不要将相同的配置服务器用于不同的分片群集。

***在配置服务器上执行的管理操作可能会对分片群集性能和可用性产生重大影响。根据受影响的配置服务器的数量，群集可能是只读的或离线一段时间。***

MongoDB mongos实例将查询和写入操作路由到分片集群中的分片。mongos从应用程序的角度提供分片集群的唯一接口。应用程序永远不会与分片直接连接或通信。

一个mongos实例路由查询到集群方式：

确定必须接收查询的分片列表。

在所有目标分片上建立游标。

如何mongos处理查询修饰符¶

排序

如果未对查询结果进行排序，则mongos 实例将打开一个结果光标，即从分片上的所有光标“循环”结果。

如果查询使用sort()cursor方法指定排序结果 ，则mongos实例会将$orderby选项传递给分片。在通过数据库将数据返回到客户端之前，数据库的主分片接收并执行所有结果的合并排序 mongos。

限制
<br>如果查询使用limit()cursor方法限制结果集的大小 ，则mongos 实例会将该限制传递给分片，然后在将结果返回给客户端之前将限制重新应用于结果。


跳过

如果查询使用 游标方法指定要跳过的记录数skip()，则无法 将跳过传递给分片，而是从分片中检索未提取的结果，并在汇编完整结果时跳过适当数量的文档。mongos

当与a一起使用时limit()， mongos将传递限制加上分片的值 skip()以提高这些操作的效率。

## Shard Keys

MongoDB尝试在群集中的 ***分片*** 之间均匀 ***分布块*** 。分片键与块分布的有效性直接相关

![分块](/img/62.png) 

***分片集合后，分片键和分片键值是不可变的*** ; 即

无法为该集合选择不同的分片键。

无法更新分片键字段的值。

唯一索引

对于分片集合，只有_id字段索引和分片键上的索引或分片键为 前缀的复合索引可以是唯一的：

不能对其他字段上具有唯一索引的集合进行分片。

无法在分片集合的其他字段上创建唯一索引。


选择分片键

分片键的选择会影响跨可用分片的块的创建和分发。这会影响分片群集中操作的整体效率和性能。

分片键会影响分片群集使用的分片策略的性能和效率 。

理想的分片键允许MongoDB在整个​​群集中均匀分发文档。


碎片关键基数

分片键的基数决定了平衡器可以创建的最大块数。这可以降低或消除群集中水平扩展的有效性。

在任何给定时间，唯一的分片键值可以存在于不超过一个块的位置。如果分片键的基数为4，则分片4群集中只能存储一个块，每个块存储一个唯一的分片键值。这也限制了集群中有效分片的数量4- 添加额外的分片不会带来任何好处。

下图说明了使用该字段X作为分片键的分片群集 。如果X基数较低，则插入的分布可能类似于以下内容：

![分片键](/img/64.png) 

此示例中的群集不会水平缩放，因为传入的写入只会路由到分片的子集。

具有高基数的分片键不保证在分片群集中均匀分布数据，但它更有利于水平缩放。分片键的频率和变化率也有助于数据分发。选择分片键时请考虑每个因素。

如果数据模型需要对基数较低的键进行分片，请考虑使用具有较高相对基数的字段的复合索引。

分片键频率

考虑表示分片键值范围的集合 - 分片键的值frequency 表示给定值在数据中出现的频率。如果大多数文档仅包含这些值的子集，则存储这些文档的块将成为群集中的瓶颈。此外，随着这些块的增长，它们可能变成不可分割的块， 因为它们无法进一步分裂。这降低或消除了群集中水平扩展的有效性。

下图说明了使用该字段X作为分片键的分片群集。如果值的子集X以高频率发生，则插入的分布可能类似于以下内容：

![分片键](/img/65.png) 

具有低频率的分片键不保证在分片群集中均匀分布数据。分片键的基数和 变化率也有助于数据分发。选择分片键时请考虑每个因素。

如果您的数据模型需要对具有高频率值的键进行分片，请考虑使用唯一或低频值的复合索引。


单调改变分片键

值单调增加或减少的分片键更有可能将插入分发到群集中的单个分片。

发生这种情况是因为每个集群都有一个块，可以捕获具有上限的范围maxKey。maxKey始终比较高于所有其他值。类似地，有一个块捕获具有下限的范围minKey。 minKey始终比较低于所有其他值。

如果分片键值始终增加，则所有新插入都将maxKey作为上限路由到块。如果分片键值始终在减小，则所有新插入都将minKey作为下限路由到块。包含该块的分片成为写操作的瓶颈。

下图说明了使用该字段X 作为分片键的分片群集。如果值X单调递增，则插入的分布可能类似于以下内容：

![分片键](/img/66.png) 

由于单调增加或减少分片键导致的不良分片密钥分发图

如果分片键值单调递减，则所有插入都将路由到。Chunk A

不单调更改的分片键不保证在分片群集中均匀分布数据。分片键的 基数和 频率也有助于数据分发。选择分片键时请考虑每个因素。

如果您的数据模型需要对单调变化的键进行分片，请考虑使用哈希分片。


散列分片

散列分片使用散列索引在共享群集中分区数据。散列索引计算单个字段的哈希值作为索引值; 此值用作分片键。

![分片键](/img/67.png) 

散列分片在分片群集中提供更均匀的数据分布，但代价是减少了目标操作与广播操作。后哈希，具有“关闭”分片键值的文档不太可能在同一块或分片上 - mongos更有可能执行 广播操作以满足给定的远程查询。 mongos可以将具有相等匹配的查询定位到单个分片。

在使用散列索引解析查询时，MongoDB会自动计算哈希值。应用程序也不会需要计算哈希值。

MongoDB hashed索引在散列之前将浮点数截断为64位整数。例如，hashed指数将存储用于持有的值的字段的值相同2.3，2.2
和2.9。要防止冲突，请不要将hashed索引用于无法可靠地转换为64位整数（然后再返回浮点数）的浮点数。MongoDB hashed索引不支持大于2^53的浮点值。

## 索引

1.  多键索引与单键索引创建形式相同，区别在于字段的值。

 单键索引:值为一个单一的值, 例如字符串,数字或者日期。多键索引:值具有多个记录，例如数组。

2.  过期索引

这适合存储一些在一段时间之后会失效的数据比如用户的登录信息、存储的日志。

3.  全文索引

全文索引还不支持中文

4.  地理位置索引

1)  查找距离某个点一定距离内的点；

2)  查找包含在某区域内的点。

5.  2d索引

平面地理位置索引

6.  2dsphere索引概念:球面地理位置索引 

## MongoDB安全

1.  最安全的是物理隔离:不现实

2.  网络隔离其次

3.  防火墙再其次

4.  用户名密码在最后

## MongoDB创建用户

1.  创建语法: createUser ( 2.6之前为addUser )

2.  角色类型:内建类型( read,readWrite,dbAdmin,dbOwner,userAdmin )

## MongoDB用户角色详解

1.数据库角色( read,readWrite,dbAdmin,dbOwner,userAdmin )

2.集群角色( clusterAdmin,clusterManager... )

3.备份角色( backup,restore... )

4.其他特殊权限( DBAdminAnyDatabase... )

