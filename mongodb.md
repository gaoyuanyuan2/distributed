# MongoDB
# 什么是MongoDB (内存、AP:最终一致性、C++）
<br>1.  没有表结构的概念,每条记录可以有完全不同的结构
<br><br>2.  业务开发方便快捷
<br><br>3.  完全的索引支持
<br><br>4.  方便的冗余与扩展
<br><br>1) 复制集保证数据安全
<br><br>2) 分片扩展数据规模
<br><br>5.  最像关系性数据库（事务、表关联、表结构）的非关系性数据库（无事务、无关联、key-value）
![](/img/63.png) 
![写](/img/60.png) 
<br>仲裁节点不存数据，监测副本集心跳。仲裁节点意义不大。一般不用此模式。
<br>分片 存储在各个节点 分发 归纳。
![读](/img/61.png) 
<br>去热点：数据存储要均衡。分块：类似redis hash槽
# MongoDB的数据结构与关系型数据库数据结构对比
|关系型数据库术语/概念|MongoDB术语/概念|  解释/说明|
|:------------:|:--:|:--:|
|Database|  Database | 数据库|
|Table | Collection  |数据库表/集合|
|  row| Document | 数据记录行/文档|
|Column | Field  |数据列/数据字段|
|Index  |Index  |素引|
|Table joins| |表关联/MongoDB不支持|
|Primary Key|Object ID  |主键MongoDB自动将，_id设置为主键|

|类型 | 典型代表|  特点|
|:--:|:--:|:--:|
|列存储| Hbase | 顾名思义，是按照列存储数据的。最大的特点是方便存储结构化和半结构化的数据，方便做数据压缩，对针对某一列或者某几列的查询有非常大的IO优势|
|文档存诸 |MongoDB | 文档存储一般用类似json的格式存储，存储的内容是文档型的。这样也就有机会对某些字段建立素引，实现关系数据库的某些功能。|
|Key-value存储| Redis |可以通过key快速查询到其value.一般来说，存储不管value的格式，照单全收。(Redis.包含了其他功能)|
# MongoDB的应用场景和不适用场景
##  1、适用场景
<br>1.  根据MongoDB官网的说明，MongoDB 的适用场景如下:
<br>1)网站实时数据:MongoDB非常适合实时的插入，更新与查询，并具备网站实时数据存储所需的复制及高度伸缩性。
<br>2)数据缓存:由于性能很高，MongoDB 也适合作为信息基础设施的缓存层。在系统重启之后，由MongoDB搭建的持久化缓存层可以避免下层的数据源过载。
<br>3)大尺寸、低价值数据存储:使用传统的关系型数据库存储一些数据时可能会比较昂贵，在此之前，很多时候程序员往往会选择传统的文件进行存储。
<br>eg：网盘数据分片存储，索引放在内存
<br>4)高伸缩性场景:MongoDB非常适合由数十或数百台服务器组成的数据库。MongoDB的路线图中已经包含对MapReduce引擎的内置支持。
<br>5)对象或JSON数据存储:MongoDB的BSON数据格式非常适合文档化格式的存储及查询。
<br><br>2、不适用场景
<br>了解了MongoDB适用场景之后，还需要了解哪些场景下不适合使用MongoDB,具体如下:
<br>1)高度事务性系统例如银行或会计系统。传统的关系型数据库目前还是更适用于需要大量原子性复杂事务的应用程序。
<br>2)传统的商业智能应用:针对特定问题的BI数据库会对产生高度优化的查询方式。对于此类应用，数据仓库可能是更合适的选择。
<br>3)需要复杂SQL查询的问题。
<br>相信通过上面的说明，你已经大致了解了MongoDB 的使用规则，需要说明一点的是，MongoDB不仅仅是数据库,更多的使用是将
MongoDB作为一个数据库中间件在实际应用中合理划分使用细节，这一点对于MongoDB应用来讲至关重要!
# MongoDB高可用方案
<br>RouteServer (路由服务器)
<br>ConfigServer (配置服务器)
<br>ReplicaSet (副本集)
<br>Shard (切片)
<br>Chunk (分块)
![分块](/img/62.png) 
<br><br>M-S-S，M-S-A 仲裁节点
<br><br>生产配置
<br>在生产群集中，确保数据冗余并确保系统具有高可用性。对于生产分片集群部署，请考虑以下事项：
<br>将Config Server部署为3成员副本集
<br>将每个Shard部署为3个成员副本集
<br>部署一个或多个mongos路由器
<br><br>在两个数据中心分发中，
<br>如果其中一个数据中心发生故障，则数据仍然可用于读取，这与单个数据中心分发不同。
<br>如果具有少数成员的数据中心发生故障，则副本集仍可以提供写操作以及读操作。
<br>但是，如果具有大多数成员的数据中心发生故障，则副本集将变为只读。
<br>如果可能，请至少在三个数据中心分发成员。对于配置服务器副本集（CSRS），最佳做法是分配三个（或更多，具体取决于成员数量）中心。
如果第三个数据中心的成本过高，一种分配的可能性是将数据承载成员均匀地分布在两个数据中心并存储其余成员（数据承载成员或仲裁者以确保成员数量奇数）
<br><br>分片需要至少两个分片来分配分片数据。
<br><br>mongos分配数量
<br><br>部署多个mongos路由器支持高可用性和可扩展性。常见的模式是mongos在每个应用程序服务器上放置一个 。mongos在每个应用服务器上部署一个 路由器可以减少应用程序和路由器之间的网络延迟。
或者，您可以将mongos路由器放在专用主机上。大型部署受益于此方法，因为它将客户端应用程序服务器的数量与mongos实例数量分离 。这样可以更好地控制mongod实例所服务的连接数。
<br><br>mongos在自己的主机上安装实例允许这些实例使用更大量的内存。内存不会与mongod实例共享。可以使用主分片来托管mongos路由器，但要注意内存争用可能会成为大型部署的问题。
<br><br>mongos您可以在部署中使用的路由器数量没有限制。但是，由于mongos路由器经常与配置服务器通信，因此在增加路由器数量时会密切监视配置服务器性能。如果您发现性能下降，那么限制mongos部署中的路由器数量可能会有所帮助 。
<br><br>配置服务器  存储分片集群的元数据。元数据反映了分片集群中所有数据和组件的状态和组织。元数据包括每个分片上的块列表以及定义块的范围。
<br><br>该mongos实例缓存这些数据，并用它来路由读写操作，以正确的碎片。mongos 当群集有元数据更改时更新缓存，例如Chunk Splits或添加分片。Shards还从配置服务器读取块元数据。
<br><br>配置服务器还存储身份验证配置信息，例如基于角色的访问控制或群集的内部身份验证设置。
<br><br>MongoDB还使用配置服务器来管理分布式锁。
<br><br>每个分片群集必须具有自己的配置服务器。不要将相同的配置服务器用于不同的分片群集。
<br><br>***在配置服务器上执行的管理操作可能会对分片群集性能和可用性产生重大影响。根据受影响的配置服务器的数量，群集可能是只读的或离线一段时间。***
# 索引
<br>1.  多键索引与单键索引创建形式相同，区别在于字段的值。
 <br>   单键索引:值为一个单一的值, 例如字符串,数字或者日期。多键索引:值具有多个记录，例如数组。
<br><br>2.  过期索引
<br>这适合存储一些在一段时间之后会失效的数据比如用户的登录信息、存储的日志。
<br><br>3.  全文索引
<br>全文索引还不支持中文
<br><br>4.  地理位置索引
<br><br>1)  查找距离某个点一定距离内的点；
<br><br>2)  查找包含在某区域内的点。
<br><br>5.  2d索引
<br>平面地理位置索引
<br><br>6.  2dsphere索引概念:球面地理位置索引 
# MongoDB安全
<br><br>1.  最安全的是物理隔离:不现实
<br><br>2.  网络隔离其次
<br><br>3.  防火墙再其次
<br><br>4.  用户名密码在最后
# MongoDB创建用户
<br>1.  创建语法: createUser ( 2.6之前为addUser )
<br><br>2.  角色类型:内建类型( read,readWrite,dbAdmin,dbOwner,userAdmin )
# MongoDB用户角色详解
<br>1.数据库角色( read,readWrite,dbAdmin,dbOwner,userAdmin )
<br><br>2.集群角色( clusterAdmin,clusterManager... )
<br><br>3.备份角色( backup,restore... )
<br><br>4.其他特殊权限( DBAdminAnyDatabase... )

